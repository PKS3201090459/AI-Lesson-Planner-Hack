import streamlit as st
import os
import pandas as pd
import plotly.express as px
import random
import time
from google import genai
from google.genai.errors import APIError
# –ú–æ–¥—É–ª–∏ Flask –∑–¥–µ—Å—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª–µ–Ω—ã, –∫–∞–∫ –≤ –≤–∞—à–µ–º —Ñ–∞–π–ª–µ
from flask import Flask, render_template, request, redirect, url_for, flash, jsonify, session
from dotenv import load_dotenv

# --- –ö–û–ù–°–¢–ê–ù–¢–´ MVP ---
LESSON_ARCHIVE_FILE = "lesson_archive.csv"
# ---------------------

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø GEMINI API ---
load_dotenv()
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
GEMINI_MODEL_NAME = "gemini-2.5-flash"
# -------------------------

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask (–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Streamlit —á–∞—Å—Ç–∏) ---
app = Flask(__name__)
app.secret_key = os.getenv("FLASK_SECRET", "a-random-secret-key-for-sessions")


# ----------------------------------------------------------------------------


# --- –§–£–ù–ö–¶–ò–ò –ü–ï–†–°–ò–°–¢–ï–ù–¢–ù–û–°–¢–ò (MVP) ---

def load_lessons_from_archive():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV-–∞—Ä—Ö–∏–≤–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ."""
    if os.path.exists(LESSON_ARCHIVE_FILE):
        try:
            # –ß–∏—Ç–∞–µ–º CSV. –ï—Å–ª–∏ –æ–Ω –ø—É—Å—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
            df = pd.read_csv(LESSON_ARCHIVE_FILE)
            return df.to_dict('records')
        except Exception:
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —á—Ç–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
            return []
    return []


def save_lessons_to_archive(lessons_list):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –≤ CSV-–∞—Ä—Ö–∏–≤."""
    if lessons_list:
        df = pd.DataFrame(lessons_list)
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Ñ–∞–π–ª
        df.to_csv(LESSON_ARCHIVE_FILE, index=False)
        return True
    return False


@st.cache_resource
def initialize_gemini_client(key):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ Gemini —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–ª—é—á–∞."""
    if key is None or key == "" or key.startswith("–í–ê–®"):
        st.error(
            "‚ùå –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à Google AI API –∫–ª—é—á —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è GEMINI_API_KEY.")
        return None, None
    try:
        client = genai.Client(api_key=key)
        return client, GEMINI_MODEL_NAME
    except Exception as e:
        st.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Google AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à API –∫–ª—é—á: {e}")
        return None, None


gemini_client, gemini_model_name = initialize_gemini_client(GEMINI_API_KEY)

# --- –ù–ê–°–¢–†–û–ô–ö–ê –ò–ù–¢–ï–†–§–ï–ô–°–ê STREAMLIT (–î–ò–ó–ê–ô–ù) ---

st.set_page_config(
    page_title="AI-LessonPlanner | DigiEduHack Aqtobe 2025",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ï–°–°–ò–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò ---
# –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞ CSV
if 'lessons' not in st.session_state:
    st.session_state.lessons = load_lessons_from_archive()


# --- –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ö–û–ù–¢–ï–ù–¢–ê (–§–£–ù–ö–¶–ò–û–ù–ê–õ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô) ---
def generate_lesson_and_test(client, model_name, theme, grade, duration):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω —É—Ä–æ–∫–∞ –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è —Å –ø–æ–º–æ—â—å—é –º–æ–¥–µ–ª–∏ Gemini.
    –í–∫–ª—é—á–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö 503 (Unavailable).
    """
    if client is None:
        return None

    # –ß–µ—Ç–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
    system_prompt = (
        "–¢—ã ‚Äî –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —É—á–∏—Ç–µ–ª—è –≤ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–µ. "
        "–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–ª–∞–Ω —É—Ä–æ–∫–∞ –∏ 5 —Ç–µ—Å—Ç–æ–≤—ã—Ö –∑–∞–¥–∞–Ω–∏–π "
        "–¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ü–µ–Ω–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Markdown."
    )

    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∑–∞–ø—Ä–æ—Å
    user_query = f"""
    –ù–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
    - **–¢–µ–º–∞ —É—Ä–æ–∫–∞:** {theme}
    - **–£—Ä–æ–≤–µ–Ω—å/–ö–ª–∞—Å—Å:** {grade}
    - **–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω):** {duration}

    –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–º —á–µ—Ç–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ Markdown:

    ## üá∞üáø –ü–ª–∞–Ω —É—Ä–æ–∫–∞: "{theme}"

    ### 1. –¶–µ–ª–∏ —É—Ä–æ–∫–∞ (5 –º–∏–Ω—É—Ç)
    [–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 2-3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏ –∏–∑–º–µ—Ä–∏–º—ã—Ö —Ü–µ–ª–∏]

    ### 2. –•–æ–¥ —É—Ä–æ–∫–∞ (–û—Å–Ω–æ–≤–Ω–æ–π —ç—Ç–∞–ø - {duration - 10} –º–∏–Ω—É—Ç)
    [–†–∞–∑–±–µ–π —É—Ä–æ–∫ –Ω–∞ 3-4 –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —ç—Ç–∞–ø–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –í–≤–µ–¥–µ–Ω–∏–µ, –ò–∑—É—á–µ–Ω–∏–µ, –ü—Ä–∞–∫—Ç–∏–∫–∞) —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –≤—Ä–µ–º–µ–Ω–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏]

    ### 3. –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ (5 –º–∏–Ω—É—Ç)
    [–ü—Ä–µ–¥–ª–æ–∂–∏ 1-2 —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –∏–ª–∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞–Ω–∏—è]

    ---

    ## ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¢–µ—Å—Ç (5 –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)

    [–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 5 –≤–æ–ø—Ä–æ—Å–æ–≤:
    - 3 –≤–æ–ø—Ä–æ—Å–∞ —Å –≤—ã–±–æ—Ä–æ–º –æ—Ç–≤–µ—Ç–∞ (—É–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –≤ —Å–∫–æ–±–∫–∞—Ö –ø–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞).
    - 2 –æ—Ç–∫—Ä—ã—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.
    ]
    """

    # –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –î–õ–Ø –°–ò–°–¢–ï–ú–ù–û–ô –ò–ù–°–¢–†–£–ö–¶–ò–ò
    config = genai.types.GenerateContentConfig(
        system_instruction=system_prompt
    )

    # --- –õ–û–ì–ò–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ü–û–í–¢–û–†–ï–ù–ò–Ø ---
    max_retries = 3
    for attempt in range(max_retries):
        try:
            response = client.models.generate_content(
                model=model_name,
                contents=user_query,
                config=config
            )
            return response.text

        except APIError as e:
            error_message = str(e).upper()
            if "503" in error_message or "UNAVAILABLE" in error_message:

                if attempt < max_retries - 1:
                    wait_time = 2 ** attempt
                    st.warning(
                        f"‚ö†Ô∏è –û—à–∏–±–∫–∞ 503 (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏). –ü–æ–ø—ã—Ç–∫–∞ {attempt + 1}/{max_retries}. –ñ–¥–µ–º {wait_time} —Å–µ–∫...")
                    time.sleep(wait_time)
                else:
                    st.error(
                        f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ AI. –î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —á–∏—Å–ª–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ ({max_retries}). –ü–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: {e}")
                    return None
            else:
                st.error(
                    f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ AI (–Ω–µ 503). –í–æ–∑–º–æ–∂–Ω–æ, –∫–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤: {e}")
                return None

        except Exception as e:
            st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")
            return None

    return None


# --- –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –î–õ–Ø –ù–ê–í–ò–ì–ê–¶–ò–ò (–î–ò–ó–ê–ô–ù) ---
st.sidebar.title("‚ú® AI-LessonPlanner")
st.sidebar.markdown("–ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è **DigiEduHack Aqtobe 2025**")
st.sidebar.markdown("---")

page = st.sidebar.radio(
    "–ù–∞–≤–∏–≥–∞—Ü–∏—è",
    ["üß† –ì–ª–∞–≤–Ω–∞—è (–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä)", "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (MVP)"],
    index=0
)

st.sidebar.markdown("---")

with st.sidebar.expander("‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ"):
    st.markdown(
        "üöÄ **MVP-–ø—Ä–æ—Ç–æ—Ç–∏–ø** —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è —É—á–µ–±–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤. "
        "–í–∫–ª—é—á–∞–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∞—Ä—Ö–∏–≤ (`.csv`) –∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç."
    )

# --- –°–¢–†–ê–ù–ò–¶–ê: –ì–ï–ù–ï–†–ê–¢–û–† –ü–õ–ê–ù–û–í (–î–ò–ó–ê–ô–ù) ---
if page == "üß† –ì–ª–∞–≤–Ω–∞—è (–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä)":

    st.title("üí° –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –£—á–µ–±–Ω–æ–≥–æ –ö–æ–Ω—Ç–µ–Ω—Ç–∞")
    st.markdown("### –°–æ–∑–¥–∞–≤–∞–π—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–ª–∞–Ω—ã —É—Ä–æ–∫–æ–≤ –∏ —Ç–µ—Å—Ç—ã –∑–∞ —Å—á–∏—Ç–∞–Ω–Ω—ã–µ —Å–µ–∫—É–Ω–¥—ã.")

    with st.container(border=True):
        st.subheader("‚öôÔ∏è –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")

        with st.form("lesson_form"):
            col1, col2 = st.columns(2)
            with col1:
                theme = st.text_input("üìù –¢–µ–º–∞ —É—Ä–æ–∫–∞", "–ö–ª–µ—Ç–æ—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –î–ù–ö –∏ –µ–µ —Ä–æ–ª—å")
            with col2:
                grade = st.selectbox("üìö –ö–ª–∞—Å—Å/–£—Ä–æ–≤–µ–Ω—å",
                                     ["5 –∫–ª–∞—Å—Å", "8 –∫–ª–∞—Å—Å", "10 –∫–ª–∞—Å—Å", "–ö–æ–ª–ª–µ–¥–∂ (1 –∫—É—Ä—Å)", "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç (2 –∫—É—Ä—Å)"],
                                     index=2)

            col3, col4 = st.columns(2)
            with col3:
                duration = st.slider("‚è±Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É—Ä–æ–∫–∞ (–º–∏–Ω)", 20, 90, 45, step=5)
            with col4:
                st.markdown("üåê **–Ø–∑—ã–∫ –æ–±—É—á–µ–Ω–∏—è**")
                lang = st.radio("", ["–†—É—Å—Å–∫–∏–π", "–ö–∞–∑–∞—Ö—Å–∫–∏–π (–ò–º–∏—Ç–∞—Ü–∏—è)"], horizontal=True, label_visibility="collapsed")

            st.markdown("---")
            submitted = st.form_submit_button("üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω –∏ —Ç–µ—Å—Ç")

    if submitted:
        if not theme:
            st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É —É—Ä–æ–∫–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.")
        else:
            with st.spinner(f'–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–ª–∞–Ω–∞ —É—Ä–æ–∫–∞ "{theme}" —Å –ø–æ–º–æ—â—å—é Gemini 2.5 Flash...'):
                result = generate_lesson_and_test(gemini_client, gemini_model_name, theme, grade, duration)

            if result:
                st.success("üéâ –ü–ª–∞–Ω —É—Ä–æ–∫–∞ –∏ —Ç–µ—Å—Ç –≥–æ—Ç–æ–≤—ã!")

                # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–§–£–ù–ö–¶–ò–û–ù–ê–õ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
                st.session_state.lessons.append({
                    "date": pd.Timestamp.now().strftime('%Y-%m-%d %H:%M'),
                    "theme": theme,
                    "grade": grade,
                    "generated_content": result,
                    "avg_score": random.randint(55, 95)
                })

                st.markdown("---")

                with st.expander("üìù –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ö–æ–Ω—Ç–µ–Ω—Ç", expanded=True):
                    st.markdown(result)

                st.markdown("---")

                col_actions = st.columns([1, 1, 1])

                col_actions[0].download_button(
                    label="üì§ –°–∫–∞—á–∞—Ç—å Markdown-—Ñ–∞–π–ª",
                    data=result,
                    file_name=f"{theme.replace(' ', '_')}_LessonPlan.md",
                    mime="text/markdown"
                )

                # 2. MVP: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ê—Ä—Ö–∏–≤ (–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ CSV
                if col_actions[1].button("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ê—Ä—Ö–∏–≤"):
                    if save_lessons_to_archive(st.session_state.lessons):
                        st.session_state.lessons = load_lessons_from_archive()  # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
                        st.success(f"‚úÖ –£—Ä–æ–∫ '{theme}' —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª **{LESSON_ARCHIVE_FILE}**.")
                    else:
                        st.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.")

                if col_actions[2].button("üîó –ü—É–±–ª–∏–∫–∞—Ü–∏—è (API-Ready)"):
                    st.info(
                        "üåê **API-Ready:** –î–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ Google Classroom —Ç—Ä–µ–±—É–µ—Ç—Å—è OAuth 2.0 –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ Google Classroom API. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏."
                    )
            else:
                st.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")


# --- –°–¢–†–ê–ù–ò–¶–ê: –ê–ù–ê–õ–ò–¢–ò–ö–ê (MVP) (–§–£–ù–ö–¶–ò–û–ù–ê–õ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù) ---
elif page == "üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ (MVP)":

    st.title("üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ü—Ä–æ–≥—Ä–µ—Å—Å–∞ –£—á–∞—â–∏—Ö—Å—è")
    st.markdown("### –ë—ã—Å—Ç—Ä—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.")

    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –∏–∑ –∞—Ä—Ö–∏–≤–∞ (–∏–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤ —Å–µ—Å—Å–∏–∏)
    if not st.session_state.lessons:
        st.warning(
            "–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏ **—Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ** –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–ª–∞–Ω–æ–≤ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞**.")

        # –§–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –∞—Ä—Ö–∏–≤ –ø—É—Å—Ç (–í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–û –ò–ó –û–†–ò–ì–ò–ù–ê–õ–ê)
        mock_data = {
            'date': ['2025-11-01', '2025-11-05', '2025-11-10'],
            'theme': ['–î—Ä–µ–≤–Ω—è—è –∏—Å—Ç–æ—Ä–∏—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞', '–ó–∞–∫–æ–Ω—ã –ù—å—é—Ç–æ–Ω–∞', '–û—Å–Ω–æ–≤—ã C++'],
            'grade': ['7 –∫–ª–∞—Å—Å', '9 –∫–ª–∞—Å—Å', '–ö–æ–ª–ª–µ–¥–∂ (1 –∫—É—Ä—Å)'],
            'avg_score': [75, 58, 88],
            'generated_content': ['...', '...', '...'],
            'students_to_repeat': [10, 15, 3]  # –î–æ–±–∞–≤–ª–µ–Ω students_to_repeat –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        }
        df_display = pd.DataFrame(mock_data).drop(columns=['generated_content'])
        st.info("üí° **–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ñ–∏–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.**")
    else:
        df_session = pd.DataFrame(st.session_state.lessons)
        # –ò–º–∏—Ç–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–§–£–ù–ö–¶–ò–û–ù–ê–õ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
        df_session['students_to_repeat'] = df_session['avg_score'].apply(
            lambda x: random.randint(1, 20) if x < 70 else random.randint(0, 5)
        )
        df_display = df_session.drop(columns=['generated_content'])

    # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ DataFrame —Å —Ä—É—Å—Å–∫–∏–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∫–æ–ª–æ–Ω–æ–∫ (–î–ò–ó–ê–ô–ù)
    df_chart = df_display.rename(columns={
        'date': '–î–∞—Ç–∞',
        'theme': '–¢–µ–º–∞',
        'grade': '–ö–ª–∞—Å—Å',
        'avg_score': '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª (%)',
        'students_to_repeat': '–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'
    })

    st.subheader("üìã –°–≤–æ–¥–∫–∞ –ø–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º —Ç–µ—Å—Ç–∞–º")
    st.dataframe(df_chart, use_container_width=True, hide_index=True)

    st.markdown("---")
    st.subheader("üìâ –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ü—Ä–æ–±–µ–ª–æ–≤ –≤ –ó–Ω–∞–Ω–∏—è—Ö")

    if '–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è' in df_chart.columns and not df_chart.empty:
        fig = px.bar(
            df_chart,
            x='–¢–µ–º–∞',
            y='–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è',
            title='–¢–µ–º—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—á–µ–Ω–∏–∫–æ–≤)',
            color='–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è',
            color_continuous_scale=px.colors.sequential.Reds,
            labels={'–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è': '–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è', '–¢–µ–º–∞': '–¢–µ–º–∞ –£—Ä–æ–∫–∞'}
        )
        fig.update_layout(
            xaxis={'categoryorder': 'total descending'},
            plot_bgcolor='rgba(0,0,0,0)',
            paper_bgcolor='rgba(0,0,0,0)'
        )
        st.plotly_chart(fig, use_container_width=True)

        # –í—ã–≤–æ–¥ AI (–§–£–ù–ö–¶–ò–û–ù–ê–õ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô)
        st.info(
            f"üî• **–í—ã–≤–æ–¥ AI:** –¢–µ–º–∞ **'{df_chart.iloc[df_chart['–£—á–µ–Ω–∏–∫–æ–≤, —Ç—Ä–µ–±—É—é—â–∏—Ö –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è'].idxmax()]['–¢–µ–º–∞']}'** —Ç—Ä–µ–±—É–µ—Ç –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π, –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –ø–ª–∞–Ω —É—Ä–æ–∫–∞ –¥–ª—è —ç—Ç–∏—Ö —É—á–µ–Ω–∏–∫–æ–≤!")
    else:
        st.warning("–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.")